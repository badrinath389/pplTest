"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PinError = void 0;
const uuid_1 = require("uuid");
const boom = require("@hapi/boom");
class PinError extends Error {
    //wrap any type of error in pinError to keep track & augment stacktrace
    constructor(data, code) {
        function getMessage(pinError) {
            if (pinError.message.constructor.name === "pinError") {
                return getMessage(pinError.message);
            }
            else if (typeof pinError.message === 'object' && pinError.message.message) {
                return data.message.message;
            }
            else if (typeof pinError.message === 'string' || pinError.message instanceof String) {
                return pinError.message;
            }
            return JSON.stringify(pinError.message);
        }
        if (typeof data === 'string') {
            super(data);
            if (code) {
                if (!isNaN(code)) {
                    this.httpStatusCode = Number(code);
                }
                else if (typeof code === 'string' || code instanceof String) {
                    this.message = this.message + " " + code.trim();
                }
            }
        }
        else if (data.constructor.name === "pinError") {
            super(getMessage(data));
            this.stack = `${data.stack.split('\n').slice(0).join('\n')}\n${this.stack.split('\n').slice(1, 2).join('\n')}`;
            if (data.httpStatusCode) {
                this.httpStatusCode = data.httpStatusCode;
            }
            if (code) {
                if (!isNaN(code)) {
                    this.httpStatusCode = Number(code);
                }
                else if (typeof code === 'string' || code instanceof String) {
                    this.message = this.message + " " + code.trim();
                }
            }
        }
        else if (data.constructor.name === "MongoError") {
            super(data.message);
            this.stack = `${data.stack.split('\n').slice(0).join('\n')}\n${this.stack.split('\n').slice(1, 2).join('\n')}`;
            if (data.httpStatusCode) {
                this.httpStatusCode = data.httpStatusCode;
            }
            if (code) {
                if (!isNaN(code)) {
                    this.httpStatusCode = Number(code);
                }
                else if (typeof code === 'string' || code instanceof String) {
                    this.message = this.message + " " + code.trim();
                }
            }
        }
        else if (data instanceof Error) {
            super(data.message);
            this.stack = `${data.stack.split('\n').slice(0).join('\n')}\n${this.stack.split('\n').slice(1, 2).join('\n')}`;
            // if (data.httpStatusCode) {
            //     this.httpStatusCode = data.httpStatusCode;
            // }
            if (code) {
                if (!isNaN(code)) {
                    this.httpStatusCode = Number(code);
                }
                else if (typeof code === 'string' || code instanceof String) {
                    this.message = this.message + " " + code.trim();
                }
            }
        }
        else if (typeof data === 'object') {
            super(data.message || JSON.stringify(data));
            if (data.httpStatusCode) {
                this.httpStatusCode = data.httpStatusCode;
            }
            else if (data.statusCode) {
                this.httpStatusCode = data.statusCode;
            }
            if (code) {
                if (!isNaN(code)) {
                    this.httpStatusCode = Number(code);
                }
                else if (typeof code === 'string' || code instanceof String) {
                    this.message = this.message + " " + code.trim();
                }
            }
        }
    }
    static _addHTTPStatusCodeAndIdToErrorIfNeeded(error) {
        error.httpStatusCode = error.httpStatusCode || 500;
        error.errorId = `error-${uuid_1.v4()}`;
    }
    static _boomReply(error) {
        const message = error.message.message || error.message || "";
        let boomReply = null;
        switch (error.httpStatusCode) {
            case 400:
                boomReply = boom.badRequest(message);
                break;
            case 401:
                boomReply = boom.unauthorized(message);
                break;
            case 403:
                boomReply = boom.forbidden(message);
                break;
            case 404:
                boomReply = boom.notFound(message);
                break;
            default:
                boomReply = boom.badImplementation("Internal Server Error");
                break;
        }
        if (error.errorId) {
            boomReply.output.payload.errorId = error.errorId;
        }
        return boomReply;
    }
    static replyWithError(request, error) {
        if (error.constructor.name !== 'pinError') {
            error = new PinError(error);
        }
        if (request) {
            request.pinError = error;
        }
        PinError._addHTTPStatusCodeAndIdToErrorIfNeeded(error);
        //now logging error with response and commenting below line; this will avoid redundancy
        // logger.getLogger().error(error);
        throw PinError._boomReply(error);
    }
}
exports.PinError = PinError;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25maWcvRXJyb3JIYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUFvQztBQUNwQyxtQ0FBbUM7QUFFbkMsTUFBYSxRQUFTLFNBQVEsS0FBSztJQUkvQix1RUFBdUU7SUFDdkUsWUFBYSxJQUFTLEVBQUUsSUFBSztRQUN6QixTQUFTLFVBQVUsQ0FBQyxRQUFRO1lBQ3hCLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRTtnQkFDbEQsT0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3ZDO2lCQUFNLElBQUksT0FBTyxRQUFRLENBQUMsT0FBTyxLQUFLLFFBQVEsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtnQkFDekUsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQzthQUMvQjtpQkFBTSxJQUFJLE9BQU8sUUFBUSxDQUFDLE9BQU8sS0FBSyxRQUFRLElBQUksUUFBUSxDQUFDLE9BQU8sWUFBWSxNQUFNLEVBQUU7Z0JBQ25GLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQzthQUMzQjtZQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUVELElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQzFCLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNaLElBQUksSUFBSSxFQUFFO2dCQUNOLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7b0JBQ2QsSUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ3RDO3FCQUFNLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxJQUFJLElBQUksWUFBWSxNQUFNLEVBQUU7b0JBQzNELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8s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O1FBQ0QsSUFBSSxPQUFPLEVBQUU7WUFDVCxPQUFPLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztTQUM1QjtRQUNELFFBQVEsQ0FBQyxzQ0FBc0MsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2RCx1RkFBdUY7UUFDdkYsbUNBQW1DO1FBQ25DLE1BQU0sUUFBUSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO0NBRUo7QUE5SEQsNEJBOEhDO0FBQUEsQ0FBQyIsImZpbGUiOiJjb25maWcvRXJyb3JIYW5kbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XHJcbmltcG9ydCAqIGFzIGJvb20gZnJvbSAnQGhhcGkvYm9vbSc7XHJcblxyXG5leHBvcnQgY2xhc3MgUGluRXJyb3IgZXh0ZW5kcyBFcnJvciB7XHJcbiAgICBwdWJsaWMgaHR0cFN0YXR1c0NvZGU6IGFueTtcclxuICAgIHB1YmxpYyBzdGFjazogYW55O1xyXG5cclxuICAgIC8vd3JhcCBhbnkgdHlwZSBvZiBlcnJvciBpbiBwaW5FcnJvciB0byBrZWVwIHRyYWNrICYgYXVnbWVudCBzdGFja3RyYWNlXHJcbiAgICBjb25zdHJ1Y3RvciAoZGF0YTogYW55LCBjb2RlPykge1xyXG4gICAgICAgIGZ1bmN0aW9uIGdldE1lc3NhZ2UocGluRXJyb3IpIHtcclxuICAgICAgICAgICAgaWYgKHBpbkVycm9yLm1lc3NhZ2UuY29uc3RydWN0b3IubmFtZSA9PT0gXCJwaW5FcnJvclwiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0TWVzc2FnZShwaW5FcnJvci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGluRXJyb3IubWVzc2FnZSA9PT0gJ29iamVjdCcgJiYgcGluRXJyb3IubWVzc2FnZS5tZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YS5tZXNzYWdlLm1lc3NhZ2U7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBpbkVycm9yLm1lc3NhZ2UgPT09ICdzdHJpbmcnIHx8IHBpbkVycm9yLm1lc3NhZ2UgaW5zdGFuY2VvZiBTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwaW5FcnJvci5tZXNzYWdlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShwaW5FcnJvci5tZXNzYWdlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgc3VwZXIoZGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChjb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGNvZGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5odHRwU3RhdHVzQ29kZSA9IE51bWJlcihjb2RlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvZGUgPT09ICdzdHJpbmcnIHx8IGNvZGUgaW5zdGFuY2VvZiBTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2UgKyBcIiBcIiArIGNvZGUudHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChkYXRhLmNvbnN0cnVjdG9yLm5hbWUgPT09IFwicGluRXJyb3JcIikge1xyXG4gICAgICAgICAgICBzdXBlcihnZXRNZXNzYWdlKGRhdGEpKTtcclxuICAgICAgICAgICAgdGhpcy5zdGFjayA9IGAke2RhdGEuc3RhY2suc3BsaXQoJ1xcbicpLnNsaWNlKDApLmpvaW4oJ1xcbicpfVxcbiR7dGhpcy5zdGFjay5zcGxpdCgnXFxuJykuc2xpY2UoMSwyKS5qb2luKCdcXG4nKX1gO1xyXG4gICAgICAgICAgICBpZiAoZGF0YS5odHRwU3RhdHVzQ29kZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5odHRwU3RhdHVzQ29kZSA9IGRhdGEuaHR0cFN0YXR1c0NvZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNvZGUpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNOYU4oY29kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmh0dHBTdGF0dXNDb2RlID0gTnVtYmVyKGNvZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29kZSA9PT0gJ3N0cmluZycgfHwgY29kZSBpbnN0YW5jZW9mIFN0cmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IHRoaXMubWVzc2FnZSArIFwiIFwiICsgY29kZS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGRhdGEuY29uc3RydWN0b3IubmFtZSA9PT0gXCJNb25nb0Vycm9yXCIpIHtcclxuICAgICAgICAgICAgc3VwZXIoZGF0YS5tZXNzYWdlKTtcclxuICAgICAgICAgICAgdGhpcy5zdGFjayA9IGAke2RhdGEuc3RhY2suc3BsaXQoJ1xcbicpLnNsaWNlKDApLmpvaW4oJ1xcbicpfVxcbiR7dGhpcy5zdGFjay5zcGxpdCgnXFxuJykuc2xpY2UoMSwyKS5qb2luKCdcXG4nKX1gO1xyXG4gICAgICAgICAgICBpZiAoZGF0YS5odHRwU3RhdHVzQ29kZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5odHRwU3RhdHVzQ29kZSA9IGRhdGEuaHR0cFN0YXR1c0NvZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNvZGUpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNOYU4oY29kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmh0dHBTdGF0dXNDb2RlID0gTnVtYmVyKGNvZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29kZSA9PT0gJ3N0cmluZycgfHwgY29kZSBpbnN0YW5jZW9mIFN0cmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IHRoaXMubWVzc2FnZSArIFwiIFwiICsgY29kZS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGRhdGEgaW5zdGFuY2VvZiBFcnJvcikge1xyXG4gICAgICAgICAgICBzdXBlcihkYXRhLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICB0aGlzLnN0YWNrID0gYCR7ZGF0YS5zdGFjay5zcGxpdCgnXFxuJykuc2xpY2UoMCkuam9pbignXFxuJyl9XFxuJHt0aGlzLnN0YWNrLnNwbGl0KCdcXG4nKS5zbGljZSgxLDIpLmpvaW4oJ1xcbicpfWA7XHJcbiAgICAgICAgICAgIC8vIGlmIChkYXRhLmh0dHBTdGF0dXNDb2RlKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmh0dHBTdGF0dXNDb2RlID0gZGF0YS5odHRwU3RhdHVzQ29kZTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICBpZiAoY29kZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpc05hTihjb2RlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaHR0cFN0YXR1c0NvZGUgPSBOdW1iZXIoY29kZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb2RlID09PSAnc3RyaW5nJyB8fCBjb2RlIGluc3RhbmNlb2YgU3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlID0gdGhpcy5tZXNzYWdlICsgXCIgXCIgKyBjb2RlLnRyaW0oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIHN1cGVyKGRhdGEubWVzc2FnZSB8fCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgIGlmIChkYXRhLmh0dHBTdGF0dXNDb2RlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHBTdGF0dXNDb2RlID0gZGF0YS5odHRwU3RhdHVzQ29kZTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLnN0YXR1c0NvZGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cFN0YXR1c0NvZGUgPSBkYXRhLnN0YXR1c0NvZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNvZGUpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNOYU4oY29kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmh0dHBTdGF0dXNDb2RlID0gTnVtYmVyKGNvZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29kZSA9PT0gJ3N0cmluZycgfHwgY29kZSBpbnN0YW5jZW9mIFN0cmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IHRoaXMubWVzc2FnZSArIFwiIFwiICsgY29kZS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIF9hZGRIVFRQU3RhdHVzQ29kZUFuZElkVG9FcnJvcklmTmVlZGVkIChlcnJvcikge1xyXG4gICAgICAgIGVycm9yLmh0dHBTdGF0dXNDb2RlID0gZXJyb3IuaHR0cFN0YXR1c0NvZGUgfHwgNTAwO1xyXG4gICAgICAgIGVycm9yLmVycm9ySWQgPSBgZXJyb3ItJHt1dWlkdjQoKX1gO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBfYm9vbVJlcGx5IChlcnJvcikge1xyXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlLm1lc3NhZ2UgfHwgZXJyb3IubWVzc2FnZSB8fCBcIlwiO1xyXG4gICAgICAgIGxldCBib29tUmVwbHkgPSBudWxsO1xyXG4gICAgICAgIHN3aXRjaCAoZXJyb3IuaHR0cFN0YXR1c0NvZGUpIHtcclxuICAgICAgICAgICAgY2FzZSA0MDA6XHJcbiAgICAgICAgICAgICAgICBib29tUmVwbHkgPSBib29tLmJhZFJlcXVlc3QobWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSA0MDE6XHJcbiAgICAgICAgICAgICAgICBib29tUmVwbHkgPSBib29tLnVuYXV0aG9yaXplZChtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIDQwMzpcclxuICAgICAgICAgICAgICAgIGJvb21SZXBseSA9IGJvb20uZm9yYmlkZGVuKG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgNDA0OlxyXG4gICAgICAgICAgICAgICAgYm9vbVJlcGx5ID0gYm9vbS5ub3RGb3VuZChtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgYm9vbVJlcGx5ID0gYm9vbS5iYWRJbXBsZW1lbnRhdGlvbihcIkludGVybmFsIFNlcnZlciBFcnJvclwiKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXJyb3IuZXJyb3JJZCkge1xyXG4gICAgICAgICAgICBib29tUmVwbHkub3V0cHV0LnBheWxvYWQuZXJyb3JJZCA9IGVycm9yLmVycm9ySWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBib29tUmVwbHk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHJlcGx5V2l0aEVycm9yIChyZXF1ZXN0LCBlcnJvcjogYW55KSB7XHJcbiAgICAgICAgaWYgKGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgIT09ICdwaW5FcnJvcicpIHtcclxuICAgICAgICAgICAgZXJyb3IgPSBuZXcgUGluRXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocmVxdWVzdCkge1xyXG4gICAgICAgICAgICByZXF1ZXN0LnBpbkVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFBpbkVycm9yLl9hZGRIVFRQU3RhdHVzQ29kZUFuZElkVG9FcnJvcklmTmVlZGVkKGVycm9yKTtcclxuICAgICAgICAvL25vdyBsb2dnaW5nIGVycm9yIHdpdGggcmVzcG9uc2UgYW5kIGNvbW1lbnRpbmcgYmVsb3cgbGluZTsgdGhpcyB3aWxsIGF2b2lkIHJlZHVuZGFuY3lcclxuICAgICAgICAvLyBsb2dnZXIuZ2V0TG9nZ2VyKCkuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIHRocm93IFBpbkVycm9yLl9ib29tUmVwbHkoZXJyb3IpO1xyXG4gICAgfVxyXG5cclxufTsiXX0=
